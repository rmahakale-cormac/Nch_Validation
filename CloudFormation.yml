---

Resources:
  CDNode:
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: us-west-2a
      ImageId: ami-775e4f16
      InstanceType: t2.large
      SubnetId: subnet-0648ad9dc2f57383d
      ScurityGroups:
        - !Ref CDNodeSG 
      UserData: 
        Fn::Base64:
          !Sub
              sudo yum update
              sudo yum install python3
              sudo pip3 install pandas
              sudo pip3 install openpyxl
              curl -O https://bootstrap.pypa.io/get-pip.py
              python3 get-pip.py
  Bastion:
    Type: AWS::EC2::Instance
    Properties:
      AvailabilityZone: us-west-2a
      ImageId: ami-08d489468314a58df
      InstanceType: t2.micro
      SubnetId: subnet-06861d10a54e283a7
      UserData: 
        Fn::Base64:
          !Sub
              sudo yum update

  CDNodeSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group to allow CD node from BDC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 1364
        ToPort: 1364
        CidrIp:	158.73.207.46/32

  CD_Load_Balancer:
  Type: AWS::ElasticLoadBalancing::LoadBalancer
  Properties:
    AvailabilityZones:
    - "us-east-2a"
    Instances:
    - Ref: logical name of AWS::EC2::CD_Prod1 #this will change
    - Ref: logical name of AWS::EC2::CD_Prod2 #this will change
    Listeners:
    - LoadBalancerPort: '80'
      InstancePort: '80'
      Protocol: HTTP
    HealthCheck:
      Target: HTTP:80/
      HealthyThreshold: '3'
      UnhealthyThreshold: '5'
      Interval: '30'
      Timeout: '5'

  CD_Launch_Config:
  Type: AWS::AutoScaling::LaunchConfiguration
  Properties:
    ImageId:    #Golden Image ID goes here
    SecurityGroups:
    - Ref: CDNodeSG
    InstanceType: t2.xlarge
    
  CD_Auto_Scaling:
  Type: AWS::AutoScaling::AutoScalingGroup
  Properties:
    AvailabilityZones:us-west-2a
    LaunchConfigurationName:
      Ref: CD_Launch_Config
    MinSize: '1'
    MaxSize: '2'
    LoadBalancerNames:
    - Ref: CD_Load_Balancer
